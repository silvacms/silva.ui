(function($,infrae,jsontemplate){var predicates_evaluator=function(predicates){var conditions=[];for(var predicate in predicates)switch(predicate){case"content_match":conditions.push(function($content,data){return infrae.utils.test(data.content,predicates.content_match)});break;case"items_match":conditions.push(function($content,data){for(var items=data.selection.items,index=items.length;index--;)if(infrae.utils.test(items[index],predicates.items_match))return!0;return!1});break;case"min_items":conditions.push(function($content,data){return data.selection.length>=predicates.min_items});break;case"max_items":conditions.push(function($content,data){return data.selection.length<=predicates.max_items});break;case"clipboard_min_items":conditions.push(function($content,data){return data.clipboard.length>=predicates.clipboard_min_items});break;case"input_mode":conditions.push(function($content,data){return data.input.status==predicates.input_mode})}return function(){for(var i=0;conditions.length>i;i++)if(!conditions[i].apply(this,arguments))return!1;return!0}};infrae.views.view({iface:["listing-changes"],factory:function($content,data,transaction){return{render:function(){var promises=[],wait=function(promise){null!==promise&&promises.push(promise)};for(var action in data.actions)switch(action){case"remove":wait(transaction.clipboard.remove(data.actions.remove)),wait(transaction.listing.remove(data.actions.remove));break;case"update":wait(transaction.clipboard.update(data.actions.update)),wait(transaction.listing.update(data.actions.update));break;case"add":wait(transaction.listing.add(data.actions.add));break;case"clear_clipboard":wait(transaction.clipboard.clear())}promises.length?$.when.apply(this,promises).done(transaction.commit):transaction.commit()}}}});var button_template=new jsontemplate.Template('<li><a class="ui-state-default" {.section description}title="{description}"{.end}>{.section icon}<div class="action-icon"><ins class="ui-icon ui-icon-{icon|htmltag}"></ins></div>{.end}<span {.section icon}class="have-icon"{.end}>{title|html}</span></a></li>',{}),build_actions_renderer=function(group_definitions,shortcuts){var renderers=[],build_group=function(definitions){var group=infrae.views.Registry(),build_button=function(definition){var button={order:definition.order,ifaces:definition.ifaces};if(null!=definition.title)button.factory=function($content,data){var view={render:function(){var $action=$(button_template.expand(definition));if(void 0!=view.action){var action=function(){return definition.confirmation?infrae.ui.ConfirmationDialog(definition.confirmation).done(view.action):view.action(),!1};$action.children("a").bind("click",action),definition.accesskey&&shortcuts.bind("listing","actions",definition.accesskey,action)}$content.append($action)}};if(void 0!=definition.action)for(var action_type in definition.action)switch(action_type){case"rest":view.action=function(){var payload=[];switch(definition.action.rest.send){case"selected_ids":infrae.utils.map(data.selection.items,function(item){return{name:"content",value:item.id}},payload);break;case"clipboard_ids":infrae.utils.map(data.clipboard.cutted,function(item){return{name:"cutted",value:item.id}},payload),infrae.utils.map(data.clipboard.copied,function(item){return{name:"copied",value:item.id}},payload)}data.query(definition.action.rest.action,payload).then(function(result){return $content.render({data:result,args:[data.get_transaction()]})})};break;case"cut":view.action=function(){var transaction=data.get_transaction();transaction.clipboard.cut(data.selection.items),transaction.commit()};break;case"copy":view.action=function(){var transaction=data.get_transaction();transaction.clipboard.copy(data.selection.items),transaction.commit()};break;case"input":view.action=function(){var save=$.Deferred(),transaction=data.get_transaction();save.done(function(values){var count=0,payload=[];return infrae.utils.each(values,function(value){if(void 0!==value){for(var name in value)payload.push({name:"values."+count+"."+name,value:value[name]});count+=1}}),count?(payload.push({name:"values",value:count}),data.query(definition.action.input.action,payload).then(function(result){return $content.render({data:result,args:[transaction]})})):$.Deferred().reject()}),transaction.rename.rename(save),transaction.commit()};break;case"input_mode":view.action=function(){var transaction=data.get_transaction();transaction.rename.collect(definition.action.input_mode),transaction.commit()};break;case"form":view.action=function(){var url=$("#content-url").attr("href"),payload=[];return infrae.utils.map(data.selection.items,function(item){return{name:definition.action.form.identifier,value:item.id}},payload),$content.SMIFormPopup({url:url+"/++rest++"+definition.action.form.name,payload:payload}).done(function(form_data){return form_data.extra?$content.render({data:form_data.extra.content,args:[data.get_transaction()]}):form_data})}}return view};else{var subgroup=build_group(definition.actions);button.factory=function($content,data){return{render:function(){var $dropdown=$('<div class="dropdown"><ol></ol></div');subgroup.render($dropdown.children("ol"),{every:data});var $first=$dropdown.find("li:first");if($first.length){var $action=$first.detach();if($dropdown.find("li:first").length){var $trigger=$action.children("a"),$opener=$('<div class="dropdown-icon"><ins class="ui-icon ui-icon-triangle-1-s"></ins></div>');$opener.bind("click",function(){return $dropdown.fadeToggle(),!1}),$dropdown.bind("mouseleave",function(){$dropdown.fadeOut("fast")}),$trigger.prepend($opener),$action.append($dropdown)}$content.append($action)}}}}}definition.available&&(button.available=predicates_evaluator(definition.available)),group.register(button)};return infrae.utils.each(definitions,build_button),group};return $.each(group_definitions,function(i,definition){var group=build_group(definition.actions),available=predicates_evaluator(definition.available);renderers.push(function($content,data){if(available($content,data)){var $actions=$('<div class="actions"><ol></ol></div>'),$container=$actions.children("ol");$actions.tipsy({delegate:"a"}),infrae.ui.selection.disable($actions),group.render($container,{every:data});var $last=$container.children("li:last");$last.length&&($last.addClass("last-action"),$content.append($actions))}})}),function($content,listing){listing.events.status(function(){shortcuts.remove("listing","actions"),$content.children("div.actions").remove();for(var index=0;renderers.length>index;index++)renderers[index]($content,this)})}},render_filter=function($filter,shortcuts,listing){var timeout=null;listing.events.content(function(){var $parent=$filter.parent();for(var name in this)if(this[name])return $parent.show(),void 0;$parent.hide()}),shortcuts.bind("listing",null,["ctrl+f"],function(){return $filter.is(":visible")?($filter.focus(),!1):void 0}),$filter.bind("keyup",function(event){var clear=!1;return 13==event.keyCode?($filter.blur(),void 0):(27==event.keyCode&&(clear=!0,$filter.blur()),timeout&&clearTimeout(timeout),timeout=setTimeout(function(){var value="";clear?$filter.val(""):value=$filter.val(),listing.filter_lines(value),timeout=null},100),void 0)})};$(document).bind("load-smilisting",function(event,data){var configuration=data.configuration,smi=data.smi,shortcuts=smi.shortcuts,render_actions=build_actions_renderer(configuration.actions,shortcuts);infrae.views.view({iface:"listing",name:"toolbar",factory:function($content,data,smi,listing){return{html_url:smi.options.listing.templates.toolbar,render:function(){render_actions($content,listing),render_filter($content.find(".filter input"),shortcuts,listing)},cleanup:function(){$content.unbind("actionrefresh-smilisting"),$content.empty()}}}})})})(jQuery,infrae,jsontemplate);