(function(e,t){var n=function(e){var n=[];for(var r in e)switch(r){case"content_match":n.push(function(n,r){return t.utils.test(r.content,e.content_match)});break;case"items_match":n.push(function(n,r){var i=r.selection.items,s=i.length;while(s--)if(t.utils.test(i[s],e.items_match))return!0;return!1});break;case"min_items":n.push(function(t,n){return n.selection.length>=e.min_items});break;case"max_items":n.push(function(t,n){return n.selection.length<=e.max_items});break;case"clipboard_min_items":n.push(function(t,n){return n.clipboard.length>=e.clipboard_min_items});break;case"input_mode":n.push(function(t,n){return n.input.status==e.input_mode})}return function(){for(var e=0;e<n.length;e++)if(!n[e].apply(this,arguments))return!1;return!0}};t.views.view({iface:["listing-changes"],factory:function(t,n,r){return{render:function(){var t=[],i=null;for(var s in n.actions){switch(s){case"remove":i=r.listing.remove(n.actions.remove);break;case"update":i=r.listing.update(n.actions.update);break;case"add":i=r.listing.add(n.actions.add);break;case"clear_clipboard":i=r.clipboard.clear(!0)}i!==null&&t.push(i)}t.length?e.when.apply(this,t).done(r.commit):r.commit()}}}});var r=function(r,i){var s=[],o=function(r){var s=t.views.Registry(),u=function(r){var u={order:r.order,ifaces:r.ifaces};if(r.title!=null)u.factory=function(n,s){var o={render:function(){var s=e('<li><a class="ui-state-default"><span>'+r.title+"</span></a></li>"),u=s.children("a");r.icon&&(u.children("span").addClass("have-icon"),u.prepend('<div class="action-icon"><ins class="ui-icon ui-icon-'+r.icon+'"></ins></div>'));if(o.action!=undefined){var a=function(){return r.confirmation?t.ui.ConfirmationDialog(r.confirmation).done(o.action):o.action(),!1};u.bind("click",a),r.accesskey&&i.bind("listing","actions",r.accesskey,a)}n.append(s)}};if(r.action!=undefined)for(var u in r.action)switch(u){case"rest":o.action=function(){var e=[];switch(r.action.rest.send){case"selected_ids":t.utils.map(s.selection.items,function(e){return{name:"content",value:e.id}},e);break;case"clipboard_ids":t.utils.map(s.clipboard.cutted,function(e){return{name:"cutted",value:e.id}},e),t.utils.map(s.clipboard.copied,function(e){return{name:"copied",value:e.id}},e)}s.query(r.action.rest.action,e).pipe(function(e){return n.render({data:e,args:[s.get_transaction()]})})};break;case"cut":o.action=function(){var e=s.get_transaction();e.clipboard.cut(s.selection.items),e.commit()};break;case"copy":o.action=function(){var e=s.get_transaction();e.clipboard.copy(s.selection.items),e.commit()};break;case"input":o.action=function(){var i=e.Deferred(),o=s.get_transaction();i.done(function(i){var u=0,a=[];return t.utils.each(i,function(e){if(e!==undefined){for(var t in e)a.push({name:"values."+u+"."+t,value:e[t]});u+=1}}),u?(a.push({name:"values",value:u}),s.query(r.action.input.action,a).pipe(function(e){return n.render({data:e,args:[o]})})):e.Deferred().reject()}),o.rename.rename(i),o.commit()};break;case"input_mode":o.action=function(){var e=s.get_transaction();e.rename.collect(r.action.input_mode),e.commit()};break;case"form":o.action=function(){var i=e("#content-url").attr("href"),o=[];return t.utils.map(s.selection.items,function(e){return{name:r.action.form.identifier,value:e.id}},o),n.SMIFormPopup({url:i+"/++rest++"+r.action.form.name,payload:o}).done(function(e){return e.extra?n.render({data:e.extra.content,args:[s.get_transaction()]}):e})}}return o};else{var a=o(r.actions);u.factory=function(t,n){return{render:function(){var r=e('<div class="dropdown"><ol></ol></div');a.render(r.children("ol"),{every:n});var i=r.find("li:first");if(i.length){var s=i.detach();if(r.find("li:first").length){var o=s.children("a"),u=e('<div class="dropdown-icon"><ins class="ui-icon ui-icon-triangle-1-s"></ins></div>');u.bind("click",function(){return r.fadeToggle(),!1}),r.bind("mouseleave",function(){r.fadeOut("fast")}),o.prepend(u),s.append(r)}t.append(s)}}}}}r.available&&(u.available=n(r.available)),s.register(u)};return t.utils.each(r,u),s};return e.each(r,function(r,i){var u=o(i.actions),a=n(i.available);s.push(function(n,r){if(!a(n,r))return;var i=e('<div class="actions"><ol></ol></div>'),s=i.children("ol");t.ui.selection.disable(i),u.render(s,{every:r});var o=s.children("li:last");o.length&&(o.addClass("last-action"),n.append(i))})}),function(e,t){t.events.status(function(){i.remove("listing","actions"),e.children("div.actions").remove();for(var t=0;t<s.length;t++)s[t](e,this)})}},i=function(e,t,n){var r="none",i=function(t){e.removeClass(r),e.addClass(t),r=t};n.events.status(function(){this.selection.length==0?i("none"):this.selection.length==this.length?i("all"):this.selection.length==1?i("single"):i("partial")});var s=function(){return r=="none"?n.select_all():n.unselect_all(),!1},o=function(){return n.unselect_all(),!1};e.bind("click",s),t.bind("listing",null,["ctrl+a"],s),t.bind("listing",null,["esc"],o)},s=function(e,t,n){var r=null;n.events.content(function(){var t=e.parent();for(var n in this)if(this[n]){t.show();return}t.hide()}),t.bind("listing",null,["ctrl+f"],function(){if(e.is(":visible"))return e.focus(),!1}),e.bind("keyup",function(t){var i=!1;if(t.keyCode==13){e.blur();return}t.keyCode==27&&(i=!0,e.blur()),r&&clearTimeout(r),r=setTimeout(function(){var t="";i?e.val(""):t=e.val(),n.filter_lines(t),r=null},100)})};e(document).bind("load-smilisting",function(e,n){var o=n.configuration,u=n.smi,a=r(o.actions,u.shortcuts);t.views.view({iface:"listing",name:"toolbar",factory:function(e,t,n,r){return{html_url:n.options.listing.templates.toolbar,render:function(){var t=n.shortcuts;a(e,r),i(e.find(".selector ins"),t,r),s(e.find(".filter input"),t,r)},cleanup:function(){e.unbind("actionrefresh-smilisting"),e.empty()}}}})})})(jQuery,infrae);