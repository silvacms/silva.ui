(function(e,t,n){var r=function(e){var n=[];for(var r in e)switch(r){case"content_match":n.push(function(n,r){return t.utils.test(r.content,e.content_match)});break;case"items_match":n.push(function(n,r){var i=r.selection.items,s=i.length;while(s--)if(t.utils.test(i[s],e.items_match))return!0;return!1});break;case"min_items":n.push(function(t,n){return n.selection.length>=e.min_items});break;case"max_items":n.push(function(t,n){return n.selection.length<=e.max_items});break;case"clipboard_min_items":n.push(function(t,n){return n.clipboard.length>=e.clipboard_min_items});break;case"input_mode":n.push(function(t,n){return n.input.status==e.input_mode})}return function(){for(var e=0;e<n.length;e++)if(!n[e].apply(this,arguments))return!1;return!0}};t.views.view({iface:["listing-changes"],factory:function(t,n,r){return{render:function(){var t=[],i=function(e){e!==null&&t.push(e)};for(var s in n.actions)switch(s){case"remove":i(r.clipboard.remove(n.actions.remove)),i(r.listing.remove(n.actions.remove));break;case"update":i(r.clipboard.update(n.actions.update)),i(r.listing.update(n.actions.update));break;case"add":i(r.listing.add(n.actions.add));break;case"clear_clipboard":i(r.clipboard.clear())}t.length?e.when.apply(this,t).done(r.commit):r.commit()}}}});var i=new n.Template('<li><a class="ui-state-default" {.section description}title="{description}"{.end}>{.section icon}<div class="action-icon"><ins class="ui-icon ui-icon-{icon|htmltag}"></ins></div>{.end}<span {.section icon}class="have-icon"{.end}>{title|html}</span></a></li>',{}),s=function(n,s){var o=[],u=function(n){var o=t.views.Registry(),a=function(n){var a={order:n.order,ifaces:n.ifaces};if(n.title!=null)a.factory=function(r,o){var u={render:function(){var o=e(i.expand(n));if(u.action!=undefined){var a=function(){return n.confirmation?t.ui.ConfirmationDialog(n.confirmation).done(u.action):u.action(),!1};o.children("a").bind("click",a),n.accesskey&&s.bind("listing","actions",n.accesskey,a)}r.append(o)}};if(n.action!=undefined)for(var a in n.action)switch(a){case"rest":u.action=function(){var e=[];switch(n.action.rest.send){case"selected_ids":t.utils.map(o.selection.items,function(e){return{name:"content",value:e.id}},e);break;case"clipboard_ids":t.utils.map(o.clipboard.cutted,function(e){return{name:"cutted",value:e.id}},e),t.utils.map(o.clipboard.copied,function(e){return{name:"copied",value:e.id}},e)}o.query(n.action.rest.action,e).then(function(e){return r.render({data:e,args:[o.get_transaction()]})})};break;case"cut":u.action=function(){var e=o.get_transaction();e.clipboard.cut(o.selection.items),e.commit()};break;case"copy":u.action=function(){var e=o.get_transaction();e.clipboard.copy(o.selection.items),e.commit()};break;case"input":u.action=function(){var i=e.Deferred(),s=o.get_transaction();i.done(function(i){var u=0,a=[];return t.utils.each(i,function(e){if(e!==undefined){for(var t in e)a.push({name:"values."+u+"."+t,value:e[t]});u+=1}}),u?(a.push({name:"values",value:u}),o.query(n.action.input.action,a).then(function(e){return r.render({data:e,args:[s]})})):e.Deferred().reject()}),s.rename.rename(i),s.commit()};break;case"input_mode":u.action=function(){var e=o.get_transaction();e.rename.collect(n.action.input_mode),e.commit()};break;case"form":u.action=function(){var i=e("#content-url").attr("href"),s=[];return t.utils.map(o.selection.items,function(e){return{name:n.action.form.identifier,value:e.id}},s),r.SMIFormPopup({url:i+"/++rest++"+n.action.form.name,payload:s}).done(function(e){return e.extra?r.render({data:e.extra.content,args:[o.get_transaction()]}):e})}}return u};else{var f=u(n.actions);a.factory=function(t,n){return{render:function(){var r=e('<div class="dropdown"><ol></ol></div');f.render(r.children("ol"),{every:n});var i=r.find("li:first");if(i.length){var s=i.detach();if(r.find("li:first").length){var o=s.children("a"),u=e('<div class="dropdown-icon"><ins class="ui-icon ui-icon-triangle-1-s"></ins></div>');u.bind("click",function(){return r.fadeToggle(),!1}),r.bind("mouseleave",function(){r.fadeOut("fast")}),o.prepend(u),s.append(r)}t.append(s)}}}}}n.available&&(a.available=r(n.available)),o.register(a)};return t.utils.each(n,a),o};return e.each(n,function(n,i){var s=u(i.actions),a=r(i.available);o.push(function(n,r){if(!a(n,r))return;var i=e('<div class="actions"><ol></ol></div>'),o=i.children("ol");i.tipsy({delegate:"a"}),t.ui.selection.disable(i),s.render(o,{every:r});var u=o.children("li:last");u.length&&(u.addClass("last-action"),n.append(i))})}),function(e,t){t.events.status(function(){s.remove("listing","actions"),e.children("div.actions").remove();for(var t=0;t<o.length;t++)o[t](e,this)})}},o=function(e,t,n){var r=null;n.events.content(function(){var t=e.parent();for(var n in this)if(this[n]){t.show();return}t.hide()}),t.bind("listing",null,["ctrl+f"],function(){if(e.is(":visible"))return e.focus(),!1}),e.bind("keyup",function(t){var i=!1;if(t.keyCode==13){e.blur();return}t.keyCode==27&&(i=!0,e.blur()),r&&clearTimeout(r),r=setTimeout(function(){var t="";i?e.val(""):t=e.val(),n.filter_lines(t),r=null},100)})};e(document).bind("load-smilisting",function(e,n){var r=n.configuration,i=n.smi,u=i.shortcuts,a=s(r.actions,u);t.views.view({iface:"listing",name:"toolbar",factory:function(e,t,n,r){return{html_url:n.options.listing.templates.toolbar,render:function(){a(e,r),o(e.find(".filter input"),u,r)},cleanup:function(){e.unbind("actionrefresh-smilisting"),e.empty()}}}})})})(jQuery,infrae,jsontemplate);