(function($,infrae,jsontemplate){var render_multi_selector=function($selector,listing,shortcuts){var status="none",set_status=function(new_status){$selector.removeClass(status),$selector.addClass(new_status),status=new_status};listing.events.status(function(){0==this.selection.length?set_status("none"):this.selection.length==this.length?set_status("all"):1==this.selection.length?set_status("single"):set_status("partial")});var switch_status=function(){return"none"==status?listing.select_all():listing.unselect_all(),!1},clear_status=function(){return listing.unselect_all(),!1};$selector.bind("click",switch_status),shortcuts.bind("listing",null,["ctrl+a"],switch_status),shortcuts.bind("listing",null,["esc"],clear_status)},render_listing_header=function($content,configuration,listing,shortcuts){var first_configuration=configuration.listing[0],$table=$content.find("div.listing-header table"),$header=$table.find("tr");$table.prepend("<colgroup>"+Array(first_configuration.columns.length+1).join("<col></col>")+"</colgroup>"),$.each(first_configuration.columns,function(index,column){var $cell=$("<th></th>");index||($cell.html('<div class="selector"><ins class="none"></ins></div>'),render_multi_selector($cell.find("ins"),listing,shortcuts)),column.caption&&$cell.text(column.caption),$header.append($cell)}),infrae.ui.selection.disable($header)},render_selection=function($viewport,$containers,selector,smi){var last_selected_index=null,$hovered_row=null,shortcuts=smi.shortcuts,get_hovered_row=function(){return null===$hovered_row&&($hovered_row=$containers.first().find("tr.item:first"),$hovered_row.addClass("hover")),$hovered_row},clear_hovered_row=function(){null!==$hovered_row&&$hovered_row.removeClass("hover"),$hovered_row=null},set_hovered_row=function($row){$row.length&&(clear_hovered_row(),$hovered_row=$row,$hovered_row.addClass("hover"))},mouved_mouse=!0;$containers.bind("mousemove",function(){mouved_mouse=!0}),$containers.delegate("tr.item","mouseenter",function(){mouved_mouse&&set_hovered_row($(this))}),$containers.delegate("tr.item","mouseleave",function(){mouved_mouse&&clear_hovered_row()}),$containers.bind("resetselection-smilisting",function(){clear_hovered_row(),last_selected_index=null});var select_row=function($row,multiple){if(null!==last_selected_index&&multiple){var current_index=$row.index();if(current_index!=last_selected_index){var start=0,end=0;current_index>last_selected_index?(start=last_selected_index+1,end=current_index+1):(start=current_index,end=last_selected_index);var $lines=$row.parent().children().slice(start,end).filter(".item:visible");selector($lines)}last_selected_index=current_index}else last_selected_index=$row.index(),selector($row)};$containers.delegate("tr.item","click",!1);var opened_dropdown=null;$containers.delegate("tr.item div.dropdown","mouseleave",function(){null!==opened_dropdown&&(opened_dropdown.fadeOut("fast"),opened_dropdown=null)}),$containers.delegate("tr.item div.dropdown-icon","mousedown",function(event){return null!==opened_dropdown&&opened_dropdown.fadeOut("fast"),opened_dropdown=$(event.target).parents("a").next(),opened_dropdown.fadeToggle(),event.preventDefault(),event.stopPropagation(),!1}),$containers.delegate("tr.item a.open-screen","mousedown",function(event){return smi.open_screen_from_link($(event.currentTarget)),event.stopPropagation(),event.preventDefault(),!1}),$containers.tipsy({gravity:"w",delegate:"ins.state"}),$containers.delegate("tr.item","mousedown",function(event){var target=$(event.target);return target.is('input[type="text"]')?(target.focus(),void 0):(select_row($(this),event.shiftKey),event.preventDefault(),event.stopPropagation(),!1)}),shortcuts.bind("listing",null,["space","shift+space"],function(event){return select_row(get_hovered_row(),event.shiftKey),!1});var scroll_line_into_view=function($line){var target,limit,top=$line.position().top,height=$line.outerHeight();25>top?(target=$viewport.scrollTop()-25+top,infrae.ui.scroll($viewport,"fast","absolute",target)):(limit=$viewport.innerHeight()-height-25,top>limit&&(target=$viewport.scrollTop()+(top-limit),infrae.ui.scroll($viewport,"fast","absolute",target)))};shortcuts.bind("listing",null,["up","shift+up"],function(event){for(var $row=get_hovered_row(),$candidate=$row.prev();$candidate.length&&!$candidate.is(":visible");)$candidate=$candidate.prev();return $candidate.length&&(mouved_mouse=!1,set_hovered_row($candidate),event.shiftKey&&select_row($candidate),scroll_line_into_view($candidate)),!1}),shortcuts.bind("listing",null,["down","shift+down"],function(event){for(var $row=get_hovered_row(),$candidate=$row.next();$candidate.length&&!$candidate.is(":visible");)$candidate=$candidate.next();return $candidate.length&&(mouved_mouse=!1,set_hovered_row($candidate),event.shiftKey&&select_row($candidate),scroll_line_into_view($candidate)),!1})},worker=infrae.deferred.LazyCallbacks(),get_dom_line=function(id){return document.getElementById("list"+(""+id))},get_lines=function(ids){if(ids.length){for(var index=ids.length-1,$lines=$(get_dom_line(ids[index]));index--;)$lines=$lines.add(get_dom_line(ids[index]));return $lines}return $([])},new_transaction=function(){var finalizer=[];return{require:function(callback){0>$.inArray(callback,finalizer)&&finalizer.push(callback)},commit:function(){setTimeout(function(){for(;finalizer.length;)finalizer.pop()()},0)}}};$(document).bind("load-smilisting",function(event,data){data.smi;var configuration=data.configuration;infrae.views.view({iface:"listing",name:"content",factory:function($content,data,smi){var listing={},selection=infrae.smi.listing.Selection(),$containers=$([]),by_name={},events={status:infrae.deferred.Callbacks(),content:infrae.deferred.Callbacks()};events.content.context(function(){var info={};for(var name in by_name)info[name]=by_name[name].$container.children("tr.item").length;return info}),events.status.context(function(){var status=selection.status();return $.extend(status,{content:data.content,clipboard:{length:smi.clipboard.length(),cutted:smi.clipboard.cutted,copied:smi.clipboard.copied},get_transaction:function(){var transaction=new_transaction();return $.extend(transaction,{rename:{rename:function(deferred){selection.rename(deferred)&&transaction.require(events.status.invoke)},collect:function(success){selection.collect(success),transaction.require(events.status.invoke)}},listing:{add:function(data){var promises=[];for(var name in by_name){var lines=data[name];lines&&lines.length&&promises.push(by_name[name].add(lines))}return promises.length?$.when.apply(null,promises).then(function(lines){var $added=$(lines);return $added.length&&(selection.select($added),transaction.require(events.content.invoke),transaction.require(events.status.invoke)),$added}):null},update:function(lines){return lines.length?worker.add(lines,function(data){var line=get_dom_line(data.id);return $(line).data("smilisting-line").update(data),line}).then(function(lines){return transaction.require(events.status.invoke),$(lines)}):null},remove:function(ids){var $lines=get_lines(ids);return $lines.length&&(selection.remove($lines),transaction.require(events.content.invoke),transaction.require(events.status.invoke)),null}},clipboard:{cut:function(data){return smi.clipboard.cut(data),transaction.require(events.status.invoke),null},copy:function(data){return smi.clipboard.copy(data),transaction.require(events.status.invoke),null},update:function(data){smi.clipboard.update(data),transaction.require(events.status.invoke)},remove:function(data){return smi.clipboard.remove(data),transaction.require(events.status.invoke),null},clear:function(){return smi.clipboard.clear(),null}}}),transaction},query:configuration.query}),status});var update_container_sizes=function(){var $header=$content.find("div.listing-header table"),$reference=null,layout=null,others=[],other_layouts=[];if(infrae.utils.each(configuration.listing,function(section){var $table,container=by_name[section.name];void 0!==container&&($table=container.$table,$table.is(":visible")&&$table.find("tr.item").length&&(null===$reference?($reference=$table,layout=section.layout):(others.push($table),other_layouts.push(section.layout))))}),null!==$reference){var update=infrae.ui.update_table_columns;update($reference,layout),update($header,{},$reference);for(var i=0;others.length>i;i++)update(others[i],other_layouts[i],$reference)}};return events.content.add(update_container_sizes),$.extend(listing,{html_url:smi.options.listing.templates.content,events:{content:function(callback){events.content.add(callback,!0)},status:function(callback){events.status.add(callback,!0)}},filter_lines:function(value){if(value){var pattern=RegExp(value,"i");$.each(configuration.listing,function(i,configuration){var $container=by_name[configuration.name].$container,$table=by_name[configuration.name].$table;$table.addClass("filtering"),$container.children(".item").each(function(){var $line=$(this);configuration.filter(pattern,$line.data("smilisting"))?$line.show():$line.hide()})})}else $.each(configuration.listing,function(i,configuration){var $container=by_name[configuration.name].$container,$table=by_name[configuration.name].$table;$table.removeClass("filtering"),$container.children(".item").show()});events.status.invoke()},unselect_all:function(){selection.unselect($containers.children("tr.item.selected:visible"))&&events.status.invoke()},select_all:function(){selection.select($containers.children("tr.item:visible"))&&events.status.invoke()},render:function(){var $listing=$content.find("dl.listing");smi.shortcuts.create("listing",$content,!0),render_listing_header($content,configuration,listing,smi.shortcuts);var promises=[];$.each(configuration.listing,function(i,configuration){var api={worker:worker};(!configuration.content_match||infrae.utils.test(data.content,configuration.content_match))&&(configuration.sortable&&infrae.utils.test(data.content,configuration.sortable.content_match)&&(api.sort=configuration.sortable.sort),promises.push(infrae.views.render($listing,{data:data.items[configuration.name],name:"listing-container",args:[configuration,api]})),$containers=$containers.add(api.$container),by_name[configuration.name]=api)}),render_selection($listing,$containers,function($items){selection.toggle($items)&&events.status.invoke()},smi),update_container_sizes(),$content.bind("collapsingchange-smilisting",function(){update_container_sizes(),events.status.invoke()}),$.when.apply(null,promises).done(function(){update_container_sizes(),$content.find(".listing-footer").render({data:data,name:"footer",args:[smi,listing]})})},cleanup:function(){worker.reset(),smi.shortcuts.remove("listing"),$content.unbind("collapsingchange-smilisting"),$content.empty()}}),listing}})}),$(document).bind("load-smiplugins",function(event,smi){$.ajax({url:smi.options.listing.configuration,async:!1,dataType:"json",success:function(configuration){var url_template=new jsontemplate.Template(smi.options.listing.action,{});for(var iface in configuration.ifaces)infrae.interfaces.register(iface,configuration.ifaces[iface]);$.extend(configuration,{query:function(action,data){return smi.ajax.query(url_template.expand({path:smi.opened.path,action:action}),data)}}),$.each(configuration.listing,function(i,section){var names=[];$.each(section.columns,function(e,column){column.filterable&&names.push(column.name)}),$.extend(section,{filter:function(pattern,data){for(var i=0,len=names.length;len>i;i++)if(data[names[i]].match(pattern))return!0;return!1}}),section.sortable&&$.extend(section.sortable,{sort:function(data){return configuration.query(section.sortable.action,data)}})}),$(document).trigger("load-smilisting",{smi:smi,configuration:configuration})}})}),infrae.smi.listing={}})(jQuery,infrae,jsontemplate);