(function(e,t,n){var r=function(e,t,n){var r="none",i=function(t){e.removeClass(r),e.addClass(t),r=t};t.events.status(function(){this.selection.length==0?i("none"):this.selection.length==this.length?i("all"):this.selection.length==1?i("single"):i("partial")});var s=function(){return r=="none"?t.select_all():t.unselect_all(),!1},o=function(){return t.unselect_all(),!1};e.bind("click",s),n.bind("listing",null,["ctrl+a"],s),n.bind("listing",null,["esc"],o)},i=function(n,i,s,o){var u=i.listing[0],a=n.find("div.listing-header table"),f=a.find("tr");a.prepend("<colgroup>"+Array(u.columns.length+1).join("<col></col>")+"</colgroup>"),e.each(u.columns,function(t,n){var i=e("<th></th>");t||(i.html('<div class="selector"><ins class="none"></ins></div>'),r(i.find("ins"),s,o)),n.caption&&i.text(n.caption),f.append(i)}),t.ui.selection.disable(f)},s=function(n,r,i,s){var o=null,u=null,a=s.shortcuts,f=function(){return u===null&&(u=r.first().find("tr.item:first"),u.addClass("hover")),u},l=function(){u!==null&&u.removeClass("hover"),u=null},c=function(e){e.length&&(l(),u=e,u.addClass("hover"))},h=!0;r.bind("mousemove",function(){h=!0}),r.delegate("tr.item","mouseenter",function(){h&&c(e(this))}),r.delegate("tr.item","mouseleave",function(){h&&l()}),r.bind("resetselection-smilisting",function(){l(),o=null});var p=function(e,t){if(o===null||!t)o=e.index(),i(e);else{var n=e.index();if(n!=o){var r=0,s=0;n>o?(r=o+1,s=n+1):(r=n,s=o);var u=e.parent().children().slice(r,s).filter(".item:visible");i(u)}o=n}};r.delegate("tr.item","click",!1);var d=null;r.delegate("tr.item div.dropdown","mouseleave",function(e){d!==null&&(d.fadeOut("fast"),d=null)}),r.delegate("tr.item div.dropdown-icon","mousedown",function(t){return d!==null&&d.fadeOut("fast"),d=e(t.target).parents("a").next(),d.fadeToggle(),t.preventDefault(),t.stopPropagation(),!1}),r.delegate("tr.item a.open-screen","mousedown",function(t){return s.open_screen_from_link(e(t.currentTarget)),t.stopPropagation(),t.preventDefault(),!1}),r.tipsy({gravity:"w",delegate:"ins.state"}),r.delegate("tr.item","mousedown",function(t){var n=e(t.target);if(n.is('input[type="text"]')){n.focus();return}return p(e(this),t.shiftKey),t.preventDefault(),t.stopPropagation(),!1}),a.bind("listing",null,["space","shift+space"],function(e){return p(f(),e.shiftKey),!1});var v=function(e){var r=e.position().top,i=e.outerHeight(),s,o;r<25?(s=n.scrollTop()-25+r,t.ui.scroll(n,"fast","absolute",s)):(o=n.innerHeight()-i-25,r>o&&(s=n.scrollTop()+(r-o),t.ui.scroll(n,"fast","absolute",s)))};a.bind("listing",null,["up","shift+up"],function(e){var t=f(),n=t.prev();while(n.length&&!n.is(":visible"))n=n.prev();return n.length&&(h=!1,c(n),e.shiftKey&&p(n),v(n)),!1}),a.bind("listing",null,["down","shift+down"],function(e){var t=f(),n=t.next();while(n.length&&!n.is(":visible"))n=n.next();return n.length&&(h=!1,c(n),e.shiftKey&&p(n),v(n)),!1})},o=t.deferred.LazyCallbacks(),u=function(e){return document.getElementById("list"+e.toString())},a=function(t){if(t.length){var n=t.length-1,r=e(u(t[n]));while(n--)r=r.add(u(t[n]));return r}return e([])},f=function(){var t=[];return{require:function(n){e.inArray(n,t)<0&&t.push(n)},commit:function(){setTimeout(function(){while(t.length)t.pop()()},0)}}};e(document).bind("load-smilisting",function(n,r){var l=r.smi,c=r.configuration;t.views.view({iface:"listing",name:"content",factory:function(n,r,l){var h={},p=t.smi.listing.Selection(),d=e([]),v={},m={status:t.deferred.Callbacks(),content:t.deferred.Callbacks()};m.content.context(function(){var e={};for(var t in v)e[t]=v[t].$container.children("tr.item").length;return e}),m.status.context(function(){var t=p.status();return e.extend(t,{content:r.content,clipboard:{length:l.clipboard.length(),cutted:l.clipboard.cutted,copied:l.clipboard.copied},get_transaction:function(){var t=f();return e.extend(t,{rename:{rename:function(e){p.rename(e)&&t.require(m.status.invoke)},collect:function(e){p.collect(e),t.require(m.status.invoke)}},listing:{add:function(n,r){var i=[];for(var s in v){var o=n[s];o&&o.length&&i.push(v[s].add(o))}return i.length?e.when.apply(null,i).then(function(n){var r=e(n);return r.length&&(p.select(r),t.require(m.content.invoke),t.require(m.status.invoke)),r}):null},update:function(n){return n.length?o.add(n,function(t){var n=u(t.id);return e(n).data("smilisting-line").update(t),n}).then(function(n){return t.require(m.status.invoke),e(n)}):null},remove:function(e){var n=a(e);return n.length&&(p.remove(n),t.require(m.content.invoke),t.require(m.status.invoke)),null}},clipboard:{cut:function(e){return l.clipboard.cut(e),t.require(m.status.invoke),null},copy:function(e){return l.clipboard.copy(e),t.require(m.status.invoke),null},update:function(e){l.clipboard.update(e),t.require(m.status.invoke)},remove:function(e){return l.clipboard.remove(e),t.require(m.status.invoke),null},clear:function(){return l.clipboard.clear(),null}}}),t},query:c.query}),t});var g=function(){var e=n.find("div.listing-header table"),r=null,i=null,s=[],o=[];t.utils.each(c.listing,function(e){var t=v[e.name],n;if(t===undefined)return;n=t.$table,n.is(":visible")&&n.find("tr.item").length&&(r===null?(r=n,i=e.layout):(s.push(n),o.push(e.layout)))});if(r!==null){var u=t.ui.update_table_columns;u(r,i),u(e,{},r);for(var a=0;a<s.length;a++)u(s[a],o[a],r)}};return m.content.add(g),e.extend(h,{html_url:l.options.listing.templates.content,events:{content:function(e){m.content.add(e,!0)},status:function(e){m.status.add(e,!0)}},filter_lines:function(t){if(t){var n=new RegExp(t,"i");e.each(c.listing,function(t,r){var i=v[r.name].$container,s=v[r.name].$table;s.addClass("filtering"),i.children(".item").each(function(t){var i=e(this);r.filter(n,i.data("smilisting"))?i.show():i.hide()})})}else e.each(c.listing,function(e,t){var n=v[t.name].$container,r=v[t.name].$table;r.removeClass("filtering"),n.children(".item").show()});m.status.invoke()},unselect_all:function(){p.unselect(d.children("tr.item.selected:visible"))&&m.status.invoke()},select_all:function(){p.select(d.children("tr.item:visible"))&&m.status.invoke()},render:function(){var u=n.find("dl.listing");l.shortcuts.create("listing",n,!0),i(n,c,h,l.shortcuts);var a=[];e.each(c.listing,function(e,n){var i={worker:o};if(n.content_match&&!t.utils.test(r.content,n.content_match))return;n.sortable&&t.utils.test(r.content,n.sortable.content_match)&&(i.sort=n.sortable.sort),a.push(t.views.render(u,{data:r.items[n.name],name:"listing-container",args:[n,i]})),d=d.add(i.$container),v[n.name]=i}),s(u,d,function(e){p.toggle(e)&&m.status.invoke()},l),g(),n.bind("collapsingchange-smilisting",function(){g(),m.status.invoke()}),e.when.apply(null,a).done(function(){g(),n.find(".listing-footer").render({data:r,name:"footer",args:[l,h]})})},cleanup:function(){o.reset(),l.shortcuts.remove("listing"),n.unbind("collapsingchange-smilisting"),n.empty()}}),h}})}),e(document).bind("load-smiplugins",function(r,i){e.ajax({url:i.options.listing.configuration,async:!1,dataType:"json",success:function(r){var s=new n.Template(i.options.listing.action,{});for(var o in r.ifaces)t.interfaces.register(o,r.ifaces[o]);e.extend(r,{query:function(e,t){return i.ajax.query(s.expand({path:i.opened.path,action:e}),t)}}),e.each(r.listing,function(t,n){var i=[];e.each(n.columns,function(e,t){t.filterable&&i.push(t.name)}),e.extend(n,{filter:function(e,t){for(var n=0,r=i.length;n<r;n++)if(t[i[n]].match(e))return!0;return!1}}),n.sortable&&e.extend(n.sortable,{sort:function(e){return r.query(n.sortable.action,e)}})}),e(document).trigger("load-smilisting",{smi:i,configuration:r})}})}),t.smi.listing={}})(jQuery,infrae,jsontemplate);