(function(infrae,$){var module={};$.extend(module,{Callbacks:function(callbacks,context_provider){callbacks||(callbacks=[]);var saved=[];return{add:function(callback,invoke){return invoke&&context_provider&&callback.apply(context_provider()),callbacks.push(callback),callback},push:function(){saved.push(callbacks),callbacks=[]},pop:function(){saved.length>0&&(callbacks=saved.pop())},clone:function(){return module.Callbacks([].concat(callbacks),context_provider)},context:function(callback){context_provider=callback},invoke:function(context,args){var index=callbacks.length;if(!args&&context_provider){var value=context_provider();context?args=[value]:context=value}for(args||(args=[]);index--;)callbacks[index].apply(context,args)}}},SemaphoreCallbacks:function(){var value=0,callbacks=[],last_args=void 0;return{use:function(){value+=1,last_args=void 0},release:function(args){if(!value||!(value-=1)){for(;callbacks.length;)callbacks.pop()(args);last_args=args}},call:function(callback){value?callbacks.push(callback):callback(last_args)}}},LazyCallbacks:function(){var timeout=null,jobs=[],Job=function(array,callback){var deferred=$.Deferred(),results=[],index=0,len=array.length,job={run:function(){for(var start=+new Date;len>index;)if(results.push(callback(array[index])),index+=1,+new Date-start>50)return timeout=setTimeout(job.run,25),void 0;timeout=null,jobs.shift(),jobs.length&&jobs[0].run(),deferred.resolve(results)},deferred:deferred};return job};return{reset:function(){var index=jobs.length;for(timeout&&(clearTimeout(timeout),timeout=null);index--;)jobs[index].deferred.reject();jobs=[]},add:function(array,callback){var idle=0===jobs.length,job=Job(array,callback);return jobs.push(job),idle&&job.run(),job.deferred.promise()}}},FluxCapacitor:function(){var handlers=[{incoming:module.Callbacks(),outgoing:module.Callbacks(),failing:module.Callbacks()}],data=[];return{events:{incoming:function(callback){return infrae.utils.apply_on_each(data,callback),handlers[0].incoming.add(callback)},outgoing:function(callback){return handlers[0].outgoing.add(callback)},failing:function(callback){return handlers[0].failing.add(callback)},push:function(){var copy={};for(var name in handlers[0])copy[name]=handlers[0][name].clone();handlers.unshift(copy)},pop:function(){handlers.length>1&&handlers.shift()}},add:function(element){return $.inArray(element,data)>-1?!1:(handlers[0].incoming.invoke(element),data.push(element),!0)},each:function(callback){return infrae.utils.apply_on_each(data,callback)},map:function(callback){return infrae.utils.apply_on_map(data,callback)},remove:function(element,failed){var index=$.inArray(element,data);return 0>index?!1:(data.splice(index,1),(failed?handlers[0].failing:handlers[0].outgoing).invoke(element),!0)},clear:function(failed){return infrae.utils.each(data,(failed?handlers[0].failing:handlers[0].outgoing).invoke),data=[],!0}}}}),infrae.deferred=module})(infrae,jQuery);