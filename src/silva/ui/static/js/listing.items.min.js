(function($,infrae){var toggle_header=function($header,$container,configuration){var $marker=$header.children("ins.ui-icon"),toggle_marker=function(){$marker.hasClass("ui-icon-triangle-1-e")?($marker.removeClass("ui-icon-triangle-1-e"),$marker.addClass("ui-icon-triangle-1-s")):($marker.removeClass("ui-icon-triangle-1-s"),$marker.addClass("ui-icon-triangle-1-e"))},toggle_collapsing=function(){configuration.collapsed=!configuration.collapsed,toggle_marker(),$header.toggleClass("collapsed"),$container.toggleClass("collapsed"),$header.trigger("collapsingchange-smilisting")};configuration.collapsed&&(toggle_marker(),$header.addClass("collapsed"),$container.addClass("collapsed"),$header.trigger("collapsingchange-smilisting")),$header.bind("click",function(){return toggle_collapsing(),!1})},sort_items=function($container,$table,callback){var original=null;$container.tableDnD({dragHandle:"moveable",onDragClass:"moving",onAllowDrop:function(row,candidate){return 0!=$(candidate).data("smilisting").moveable},onDragStart:function(row){return $table.hasClass("filtering")?!1:(original=$(row).parent("tr").index(),$table.trigger("resetselection-smilisting"),$table.removeClass("static"),void 0)},onDrop:function(row){var $line=$(row),position=$line.index(),data=$line.data("smilisting");position!=original?(position>original&&(original-=1),$container.children("tr.item:first").data("smilisting").moveable||(position-=1),callback([{name:"content",value:data.id},{name:"position",value:position}]).then(function(success){return success||(original>position&&(original-=1),$line.detach(),$line.insertAfter($container.children("tr.item:eq("+original+")"))),$table.addClass("static"),success})):$table.addClass("static")}})};infrae.views.view({iface:"listing-items",name:"listing-container",factory:function($listing,data,configuration,api){var insert_line=function($line,data,position){if(position>-1){var $after=api.$container.children().eq(position);$after.length?$after.before($line):api.$container.append($line)}else api.$container.append($line)},render_line=function(data){var $line=$('<tr class="item"></tr>'),line={};$line.attr("id","list"+(""+data.id));var render_cell=function(column){var $cell=$("<td></td>");column.view&&($cell.bind("refreshcell-smilisting",function(event,data){var $cell=$(this),value=null;column.name&&(value=data[column.name]),infrae.smi.listing.columns.render($cell,{data:data,name:column.view,ifaces:["object"],args:[column,value]}),event.stopPropagation(),event.preventDefault()}),void 0!==column.name&&void 0!==column.renameable&&($cell.addClass("renameable"),$cell.bind("renamecell-smilisting",function(event,data){if(event.stopPropagation(),event.preventDefault(),void 0===column.renameable.item_match||infrae.utils.test(data,column.renameable.item_match)){var $cell=$(this),$field=$('<input class="renaming" type="text" />');$field.attr("name",column.name),$field.val(data[column.name]),$cell.empty(),$cell.append($field)}}))),$line.append($cell)};return infrae.utils.each(configuration.columns,render_cell),$.extend(line,{update:function(data){if(void 0!=data){if($line.data("smilisting",data),data.position>-1){var new_position=data.position,$first=api.$container.children("tr.item:first");$first.length&&$first.data("smilisting").moveable&&(new_position-=1),new_position>0&&api.$container.children().index($line)!=new_position&&($line.detach(),insert_line($line,data,new_position))}}else data=$line.data("smilisting");$line.children().each(function(){$(this).triggerHandler("refreshcell-smilisting",data)})},rename:function(){var data=$line.data("smilisting");$line.find("td.renameable").each(function(){$(this).triggerHandler("renamecell-smilisting",data)})},values:function(){var $inputs=$line.find("input.renaming");if(!$inputs.length)return void 0;var data=$line.data("smilisting"),values={id:data.id};return $inputs.each(function(){var $input=$(this);values[$input.attr("name")]=$input.val()}),values}}),line.update(data),$line.data("smilisting-line",line),insert_line($line,data,data.position),$line.get(0)};return $.extend(api,{title:configuration.title,add:function(lines,initial){var deferred=$.Deferred();return lines.length?(initial||api.$table.children(".empty").remove(),api.$table.prepend("<colgroup>"+Array(configuration.columns.length+1).join("<col></col>")+"</colgroup>"),this.add=function(lines){return api.worker.add(lines,render_line)},api.add(lines)):(initial&&api.$table.append('<tr class="empty"><td colpsan="'+configuration.columns.length+'">There are no items here.</td></tr>'),deferred.resolve([]),deferred.promise())},$container:null,$table:null}),$.extend({template_append:!0,jsont:'<dt class="ui-state-default"><ins class="ui-icon ui-icon-triangle-1-s"></ins>{title}</dt><dd><table class="static"><tbody></tbody></table></dd>',render:function($content){return api.$table=$content.find("table"),api.$container=api.$table.find("tbody"),toggle_header($content.filter("dt"),$content.filter("dd"),configuration),api.sort&&sort_items(api.$container,api.$table,api.sort),api.add(data.items,!0)}},api)}})})(jQuery,infrae,jsontemplate);