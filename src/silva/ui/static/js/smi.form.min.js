(function($,infrae){$.fn.invoke=function(){return Array.prototype.splice.call(arguments,0,1)[0].apply(this,arguments)};var scroll_field_into_view=function($field){if($field.length){var target,limit,top=$field.position().top,height=$field.outerHeight(),$container=$(this);25>top?(target=$container.scrollTop()-25+top,infrae.ui.scroll($container,"fast","absolute",target)):(limit=$container.innerHeight()-height-25,top>limit&&(target=$container.scrollTop()+(top-limit),infrae.ui.scroll($container,"fast","absolute",target)))}},unfocus_form_fields=function(){$(this).find(".form-section").removeClass("form-focus")},focus_form_field=function($field,no_input_focus){var $section=$field.closest(".form-section");$section.is(".form-focus")||($(this).invoke(unfocus_form_fields),$section.addClass("form-focus"),no_input_focus||$section.find(".field:first").focus())},focus_first_form_field=function(){var $forms=$(this),$field=$forms.find(".form-error:first").find(".field:first");$field.length||($field=$forms.find(".field-required:first"),$field.length||($field=$forms.find(".field:first"))),$field.length&&($forms.invoke(focus_form_field,$field),$forms.invoke(scroll_field_into_view,$field.closest(".form-section")))},focus_next_form_field=function(){var $forms=$(this),$focused=$forms.find(".form-focus"),$field=$focused.next();if(!$field.length){var $next_body=$focused.closest(".form-body").nextAll(".form-body");if($next_body.length)$field=$next_body.find(".form-section:first");else{var $next_form=$focused.closest("form").nextAll("form");$field=$next_form.length?$next_form.find(".form-section:first"):$forms.find(".form-section:first")}}$forms.invoke(focus_form_field,$field),$forms.invoke(scroll_field_into_view,$field)},focus_previous_form_field=function(){var $forms=$(this),$focused=$forms.find(".form-focus"),$field=$focused.prev();if(!$field.length){var $prev_body=$focused.closest(".form-body").prevAll(".form-body");if($prev_body.length)$field=$prev_body.find(".form-section:last");else{var $prev_form=$focused.closest("form").prevAll("form");$field=$prev_form.length?$prev_form.find(".form-section:last"):$forms.find(".form-section:last")}}$forms.invoke(focus_form_field,$field),$forms.invoke(scroll_field_into_view,$field)};$(".form-content").live("load-smiform",function(event,data){var $container=data.container||$(this),$form=data.form||$container.find("form"),focus_form_event=function(event){var $target=$(event.target),$section=$target.closest(".form-section"),is_cancelable=$target.is("input")||$target.is("a");$container.invoke(focus_form_field,$section,is_cancelable),is_cancelable||event.stopPropagation()};$container.delegate(".form-section","click",focus_form_event),$container.delegate(".form-section","focusin",focus_form_event),$container.delegate(".form-error-detail","click",function(){$(this).fadeOut().promise().done(function(){$(this).remove()})}),$container.invoke(focus_first_form_field),$form.trigger("loadwidget-smiform",data)}),infrae.views.view({iface:"form",name:"content",factory:function($content,data,smi){var $content_form=null,$forms=$([]);return{template_data:!0,render:function(){if(data.portlets){var $content_portlets=$('<div class="portlets form-content"></div>');$content_form=$('<div class="forms form-content"></div>'),$content_portlets.html(data.portlets),$content.append($content_form),$content.append($content_portlets)}else $content_form=$content,$content_form.addClass("form-content");$content_form.html(data.forms),$forms=$content_form.find("form"),smi.shortcuts.create("form",$content_form,!0),$forms.each(function(){var $form=$(this),form_prefix=$form.attr("name"),make_submit=function($control){var message=$control.attr("data-confirmation");return void 0!==message?function(){return infrae.ui.ConfirmationDialog({message:message}).pipe(function(){return submit($control)}),!1}:function(){return submit($control)}},submit=function($control){$form.trigger("serialize-smiform",{form:$form,container:$content_form});var values=$form.serializeArray(),is_link=!1;return void 0!==$control&&$control.length&&(values.push({name:$control.attr("name"),value:$control.text()}),is_link=$control.hasClass("link-control")),is_link?($control.attr("href",[smi.get_screen_url(),"?",$.param(values)].join("")),void 0):(smi.ajax.send_to_opened(values),!1)};$form.bind("submit",make_submit($form.find(".form-controls a.default-form-control"))),$form.find(".form-controls a.form-control").each(function(){var $control=$(this),shortcut=$control.attr("data-form-shortcut"),handler=make_submit($control);$control.bind("click",handler),shortcut&&smi.shortcuts.bind("form",null,[shortcut],handler)}),$form.find(".form-controls a.form-button").each(function(){var $control=$(this),shortcut=$control.attr("data-form-shortcut");shortcut&&smi.shortcuts.bind("form",null,[shortcut],function(){return $control.click(),!1})}),$form.delegate(".form-controls a.form-popup","click",function(){var $control=$(this);return $control.SMIFormPopup().done(function(data){data.extra&&data.extra.refresh==form_prefix&&submit()}),!1}),$form.tipsy({delegate:"a.form-control"}),$form.tipsy({delegate:"a.form-button"}),$form.attr("data-form-url",smi.get_screen_url())}),$content_form.trigger("load-smiform",{form:$forms,container:$content_form}),smi.shortcuts.bind("form",null,["ctrl+down","ctrl+shift+down"],function(){return $content_form.invoke(focus_next_form_field),!1}),smi.shortcuts.bind("form",null,["ctrl+up","ctrl+shift+up"],function(){return $content_form.invoke(focus_previous_form_field),!1})},cleanup:function(){null!==$content_form&&$content_form.trigger("clean-smiform",{form:$forms,container:$content_form}),smi.shortcuts.remove("form"),$content.undelegate(".form-section","focusin"),$content.undelegate(".form-section","click"),$content.removeClass("form-content"),$content.empty()}}}})})(jQuery,infrae);