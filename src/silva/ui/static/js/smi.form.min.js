(function(e,t){e.fn.invoke=function(){return Array.prototype.splice.call(arguments,0,1)[0].apply(this,arguments)};var n=function(n){if(!n.length)return;var r=n.position().top,i=n.outerHeight(),s=e(this),o,u;r<25?(o=s.scrollTop()-25+r,t.ui.scroll(s,"fast","absolute",o)):(u=s.innerHeight()-i-25,r>u&&(o=s.scrollTop()+(r-u),t.ui.scroll(s,"fast","absolute",o)))},r=function(){e(this).find(".form-section").removeClass("form-focus")},i=function(t,n){var i=t.closest(".form-section");if(i.is(".form-focus"))return;e(this).invoke(r),i.addClass("form-focus"),n||i.find(".field:first").focus()},s=function(){var t=e(this),r=t.find(".form-error:first").find(".field:first");r.length||(r=t.find(".field-required:first"),r.length||(r=t.find(".field:first"))),r.length&&(t.invoke(i,r),t.invoke(n,r.closest(".form-section")))},o=function(){var t=e(this),r=t.find(".form-focus"),s=r.next();if(!s.length){var o=r.closest(".form-body").nextAll(".form-body");if(o.length)s=o.find(".form-section:first");else{var u=r.closest("form").nextAll("form");u.length?s=u.find(".form-section:first"):s=t.find(".form-section:first")}}t.invoke(i,s),t.invoke(n,s)},u=function(){var t=e(this),r=t.find(".form-focus"),s=r.prev();if(!s.length){var o=r.closest(".form-body").prevAll(".form-body");if(o.length)s=o.find(".form-section:last");else{var u=r.closest("form").prevAll("form");u.length?s=u.find(".form-section:last"):s=t.find(".form-section:last")}}t.invoke(i,s),t.invoke(n,s)};e(document).on("load-smiform",".form-content",function(t,n){var r=n.container||e(this),o=n.form||r.find("form"),u=function(t){var n=e(t.target),s=n.closest(".form-section"),o=n.is("input")||n.is("a");r.invoke(i,s,o),o||t.stopPropagation()};r.delegate(".form-section","click",u),r.delegate(".form-section","focusin",u),r.delegate(".form-error-detail","click",function(){e(this).fadeOut().promise().done(function(){e(this).remove()})}),r.invoke(s),o.trigger("loadwidget-smiform",n)}),t.views.view({iface:"form",name:"content",factory:function(n,r,i){var s=null,a=e([]);return{template_data:!0,render:function(){if(r.portlets){var f=e('<div class="portlets form-content"></div>');s=e('<div class="forms form-content"></div>'),f.html(r.portlets),n.append(s),n.append(f)}else s=n,s.addClass("form-content");s.html(r.forms),a=s.find("form"),i.shortcuts.create("form",s,!0),a.each(function(){var n=e(this),r=n.attr("name"),o=function(e){var n=e.attr("data-confirmation");if(n!==undefined){var r=e.attr("data-confirmation-title");return r||(r="Please confirm"),function(){return t.ui.ConfirmationDialog({title:r,message:n}).then(function(){return u(e)}),!1}}return function(){return u(e)}},u=function(t){n.trigger("serialize-smiform",{form:n,container:s});var r=n.serializeArray(),o=!1;t!==undefined&&t.length&&(r.push({name:t.attr("name"),value:t.text()}),o=t.hasClass("link-control"));if(!o)return i.ajax.send_to_opened(r),!1;t.attr("href",[i.get_screen_url(),"?",e.param(r)].join(""))};n.bind("submit",o(n.find(".form-controls a.default-form-control"))),n.find(".form-controls a.form-control").each(function(){var t=e(this),n=t.attr("data-form-shortcut"),r=o(t);t.bind("click",r),n&&i.shortcuts.bind("form",null,[n],r)}),n.find(".form-controls a.form-button").each(function(){var t=e(this),n=t.attr("data-form-shortcut");n&&i.shortcuts.bind("form",null,[n],function(){return t.click(),!1})}),n.delegate(".form-controls a.form-popup","click",function(){var t=e(this);return t.SMIFormPopup().done(function(e){e.extra&&e.extra.refresh==r&&u()}),!1}),n.tipsy({delegate:"a.form-control"}),n.tipsy({delegate:"a.form-button"}),n.attr("data-form-url",i.get_screen_url())}),s.trigger("load-smiform",{form:a,container:s}),i.shortcuts.bind("form",null,["ctrl+down","ctrl+shift+down"],function(){return s.invoke(o),!1}),i.shortcuts.bind("form",null,["ctrl+up","ctrl+shift+up"],function(){return s.invoke(u),!1})},cleanup:function(){s!==null&&s.trigger("clean-smiform",{form:a,container:s}),i.shortcuts.remove("form"),n.undelegate(".form-section","focusin"),n.undelegate(".form-section","click"),n.removeClass("form-content"),n.empty()}}}})})(jQuery,infrae);