(function(e,t,n){var r=/#([^!]*)!?(.*)/,i=function(e){var t={ifaces:["redirect"],path:"",screen:"",default_screen:function(){var n=i(e);return n.path=t.path,n.screen=e,n},is_default_screen:function(){return t.screen===e},copy:function(e){t.path=e.path,t.screen=e.screen},equal:function(e){return t.path==e.path&&t.screen==e.screen},open:function(e,n){e||(e=t.path),n||(n=t.screen),document.location.hash=n+"!"+e},read:function(n){var i=r.exec(n);i?(t.screen=i[1],t.path=i[2]):(t.screen="",t.path=""),t.screen.length||(t.screen=e)}};return t};e.fn.SMI=function(r){var s={objection:null,ready:t.deferred.StackCallbacks(),options:r,opened:i("content"),opening:i("content"),shortcuts:t.keyboard.ShortcutManager(document)},o=e(r.workspace.selector),u=o.children(".header"),a=o.children(".content");t.ui.selection.disable(u.children(".metadata")),r.theme&&r.theme.background&&e("html").css("background-color",r.theme.background);var f=new n.Template(r.screen,{}),l=new n.Template(r.action,{}),c=new n.Template(r.workspace.url,{}),h,p={},d=t.views.HTMLResourceManager(e(document)),v={};for(h in t.smi.plugins)p[h]=t.smi.plugins[h](s,r);t.views.view({iface:"screen",factory:function(e,t,n){return{render:function(){a.render({data:t.screen,name:"content",args:[n]}).done(function(){t.metadata!==undefined&&u.render({data:t.metadata,name:"header",args:[n,c,this]})})}}}}),e.extend(s,{clipboard:t.smi.ClipBoardManager(p.notifications),get_language:function(){var t=e("html").attr("lang");return t||(t="en"),t},get_screen_url:function(e){return e||(e=s.opened),f.expand(e)},open_screen:function(e,t){s.opened.open(e,t)},open_screen_from_link:function(e){var t=e.attr("href");if(!t||t=="#")t=s.opened.path;s.open_screen(t,e.attr("rel"))}}),e(document).delegate("a.open-screen","click",function(t){return s.open_screen_from_link(e(this)),!1}),e.extend(s,{ajax:{query:function(n,r,i){var o={};return o.url=n,o.dataType="json",r&&(o.type="POST",o.data=r),e.ajax(o).pipe(function(n){var r=e.Deferred().resolve(),i=e.Deferred(),s;n.resources!=undefined&&(n.resources.js&&(r=r.pipe(function(){return e.when.apply(e,t.utils.map(n.resources.js,d.load_js))})),n.resources.css&&t.utils.each(n.resources.css,d.load_css));for(s in p)p[s].page!==undefined&&p[s].page(n);return r.done(function(){i.resolve(n.content)}),i},function(t){if(!s.options.testing){i===undefined&&(i=v);var n=i[t.status];n===undefined&&(n=i[500]);var r=n(t);if(r)return r.promise!==undefined?r:e(document).render({data:r,args:[s],reject:[t]})}return e.Deferred().reject(t)})},vote:function(t){if(!s.objection)return t();var n=s.objection();return n||(n=e.Deferred(),n.resolve()),n.done(function(){s.objection=null}),n.pipe(t,function(){return e.Deferred(function(e){e.reject({status:417})})})},lock:function(e){return s.ready.use(),e().pipe(function(){return s.ready.release(200),{}},function(e){return s.ready.release(e.status),{}})},create_error_handlers:function(e,t){var n={},r,i;t===undefined&&(t=v);for(i in t)n[i]=t[i];for(i in e)r=t[i],r===undefined&&(r=t[500]),n[i]=e[i](r);return n},send_to_opened:function(t,n){return s.ajax.lock(function(){return s.ajax.vote(function(){return s.ajax.query(s.get_screen_url(s.opening),t,n).pipe(function(t){return s.opened.copy(s.opening),e(document).render({data:t,args:[s]})})}).pipe(null,function(e){return s.opening.equal(s.opened)||(s.opening.copy(s.opened),s.opening.open()),e})})}},open_action_from_link:function(t){return s.ajax.lock(function(){return s.ajax.vote(function(){var n=t.attr("rel"),r=t.attr("href");return r||(r=s.opened.path),s.ajax.query(l.expand({path:r,action:n}),{path:s.opened.path,screen:s.opened.screen}).pipe(function(t){return e(document).render({data:t,args:[s]})})})})}}),v=function(){var t=function(t){return function(n){try{var r=e.parseJSON(n.responseText),i;for(i in p)p[i].error!==undefined&&p[i].error(r);return r.content}catch(s){return t(n)}}};return s.ajax.create_error_handlers({400:t,401:t},r.error_messages)}(),e(document).delegate("a.open-action","click",function(t){return s.open_action_from_link(e(this)),!1}),e(document).trigger("load-smiplugins",s);var m=function(t){var n=s.ajax.create_error_handlers({404:function(t){return function(n){return s.opening.is_default_screen()?t(n):e.Deferred().resolve(s.opening.default_screen())}}});return m=function(e){s.opening.read(e),s.opening.equal(s.opened)||s.ajax.send_to_opened(undefined,n)},m(t)};return e(window).hashchange(function(e,t){m(t.after)}),m(document.location.hash),s},t.smi={plugins:{}}})(jQuery,infrae,jsontemplate);