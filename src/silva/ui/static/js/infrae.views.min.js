(function($,infrae,jsontemplate){var BUNDLE_RE=/^:bundle:/;$.ajaxSetup({cache:!1});var HTMLResourceTracker=function(){var urls=[],analyze_url=function(original){var parts=original.split("/"),last=parts[parts.length-1];if(last.match(BUNDLE_RE)){parts.pop();var i,files=last.substr(8).split(";"),prefix=parts.join("/"),result=[];for(i=0;files.length>i;i++)result.push({url:[prefix,files[i]].join("/"),file:files[i],prefix:prefix});return result}return[{url:original,file:null,prefix:original}]};return{register:function(new_url){var i,new_urls=analyze_url(new_url);for(i=0;new_urls.length>i;i++)0>$.inArray(new_urls[i].url,urls)&&urls.push(new_urls[i].url)},validate:function(new_url){var i,prefix,files,new_urls=analyze_url(new_url),missing_urls={},result=[];for(i=0;new_urls.length>i;i++)0>$.inArray(new_urls[i].url,urls)&&(prefix=new_urls[i].prefix,void 0===missing_urls[prefix]&&(missing_urls[prefix]=[]),missing_urls[prefix].push(new_urls[i]));for(prefix in missing_urls)if(1==missing_urls[prefix].length&&null===missing_urls[prefix][0].file)result.push(missing_urls[prefix][0].url);else{for(files=[],i=0;missing_urls[prefix].length>i;i++)files.push(missing_urls[prefix][i].file);result.push([prefix,":bundle:"+files.join(";")].join("/"))}return result}}},module={HTMLResourceManager:function($document){var data={css:HTMLResourceTracker(),js:HTMLResourceTracker()},root=$document.get(0),head=root.getElementsByTagName("head")[0],resources={load_js:function(scripts){var urls=infrae.utils.map_concat(scripts,data.js.validate);return urls.length?$.when.apply($,infrae.utils.map(urls,function(url){var script_tag=root.createElement("script"),promise=$.Deferred();return script_tag.async="async",script_tag.type="text/javascript",script_tag.readyState?script_tag.onreadystatechange=function(){("loaded"==script_tag.readyState||"complete"==script_tag.readyState)&&(script_tag.onreadystatechange=null,promise.resolve())}:script_tag.onload=function(){promise.resolve()},script_tag.src=url,head.appendChild(script_tag),data.js.register(url),promise})):$.Deferred().resolve()},load_css:function(csses){var urls=infrae.utils.map_concat(csses,data.css.validate);return urls.length?$.when.apply($,infrae.utils.map(urls,function(url){var link_tag=root.createElement("link");return link_tag.rel="stylesheet",link_tag.type="text/css",link_tag.href=url,head.appendChild(link_tag),data.css.register(url),$.Deferred().resolve()})):$.Deferred().resolve()}};return $document.ready(function(){$("script").each(function(){var src=$(this).attr("src");void 0!=src&&data.js.register(src)}),$("link").each(function(){var $link=$(this);if("stylesheet"==$link.attr("rel")&&"text/css"==$link.attr("type")){var src=$link.attr("href");void 0!=src&&data.css.register(src)}})}),resources}},template_cache={},View=function($content,data,factory,args,reject){var view={$content:$content,data:data};$.extend(view,factory.apply($content,args));var render=function(template){view.template_append||($content.triggerHandler("cleanup-infrae-views"),(view.cleanup||view.iframe)&&$content.one("cleanup-infrae-views",function(){view.cleanup&&view.cleanup(),view.iframe&&($(window).unbind("resize.infrae-views-iframe"),$(window).unbind("workspace-resize-smi.infrae-views-iframe"),$content.removeClass("iframe-view"))}));var deferred=$.Deferred(),$context=$content,resolve=function(){void 0!=reject?deferred.rejectWith(view,reject):deferred.resolveWith(view)},finalizer=function(){var done=null;return void 0!=view.render&&(done=view.render($context),done&&done.promise)?(done.promise().done(resolve),void 0):(resolve(),void 0)};if(view.iframe){if(view.template_append)throw{message:"Cannot use iframe and template_append together"};var $iframe=$('<iframe src="">');view.$iframe=$iframe;var resize=function(){var height=$content.innerHeight(),width=$content.innerWidth();view.resize_iframe&&view.resize_iframe(width,height)||($iframe.height(height),$iframe.width(width))};resize(),$(window).bind("resize.infrae-views-iframe",resize),$(window).bind("workspace-resize-smi.infrae-views-iframe",resize),$content.addClass("iframe-view"),$content.html($iframe);var iframe_window=$iframe.get(0).contentWindow,iframe_document=iframe_window.document;if(view.$window=$(iframe_window),view.$document=$(iframe_document),void 0!==template){view.ready=$.Deferred();var loader=function(){view.ready.resolve(view)};0>template.indexOf("<html")&&0>template.indexOf("<HTML")&&(template="<html><body>"+template+"</body></html>"),iframe_document.write(template),iframe_document.close(),"complete"==iframe_document.readyState?loader():iframe_window.addEventListener?iframe_window.addEventListener("load",loader,!1):iframe_window.attachEvent("onload",loader)}}else void 0!==template&&(view.template_append?($context=$(template),$content.append($context)):$content.html(template));return finalizer(),deferred.promise()};return function(){var template=void 0,jsont_url=view.template_data&&data.jsont_url||view.jsont_url;if(jsont_url)return view.template_nocache||(template=template_cache[jsont_url],void 0===template)?$.ajax({type:"GET",url:jsont_url}).then(function(payload){var template=new jsontemplate.Template(payload,{});return template_cache[jsont_url]=template,render(template.expand(data))}):render(template.expand(view));var html_url=view.template_data&&data.html_url||view.html_url;if(html_url)return view.template_nocache||(template=template_cache[html_url],void 0===template)?$.ajax({type:"GET",url:html_url}).then(function(payload){return template_cache[html_url]=payload,render(payload)}):render(template);var jsont=view.template_data&&data.jsont||view.jsont;if(void 0!==jsont)return template=template_cache[jsont],void 0===template&&(template=new jsontemplate.Template(jsont,{}),template_cache[jsont]=template),render(template.expand(view));var html=view.template_data&&data.html||view.html;return void 0!==html?render(html):render()}};$.extend(module,{Registry:function(){var views={},count=0,render_best_view=function($content,data,options){var ifaces=options.ifaces||infrae.interfaces.implemented_by(data),named_views=views[options.name],to_render=null,args=[$content,data].concat(options.args),reject=options.reject;if(named_views)for(var i=0;ifaces.length>i;i++){var definitions=named_views[ifaces[i]];if(definitions&&definitions.length){to_render=View($content,data,definitions[0].factory,args,reject);break}}return null!=to_render?to_render():(window.console&&console.log&&console.log("failed view lookup for options",options,"and",data),$.Deferred().reject({status:604}))},render_all_views=function($content,data,options){var named_views=views[options.name];if(void 0==named_views)return[];var ifaces=options.ifaces||infrae.interfaces.implemented_by(data),seen_definitions=[],to_render=[],args=[$content,data].concat(options.args),reject=options.reject;return infrae.utils.each(ifaces,function(iface){var definitions=named_views[iface];definitions&&infrae.utils.each(definitions,function(definition){if(0>$.inArray(definition.__view_uid__,seen_definitions)){if(seen_definitions.push(definition.__view_uid__),void 0!=definition.available&&!definition.available.apply(definition,args))return;to_render.push([definition.order,View($content,data,definition.factory,args,reject)])}})}),to_render.sort(function(v1,v2){return v1[0]-v2[0]}),$.each(to_render,function(i,data){data[1]()}),null},render_url=function($content,url,options){return $.ajax({type:"GET",url:url,dataType:"json"}).then(function(data){return render_best_view($content,data,options)})},registry={register:function(definition){void 0==definition.name&&(definition.name="default"),void 0==definition.order&&(definition.order=0),definition.__view_uid__=""+count,count+=1;var add=function(definition,iface){views[definition.name]||(views[definition.name]={}),views[definition.name][iface]||(views[definition.name][iface]=[]),views[definition.name][iface].unshift(definition)};definition.ifaces?infrae.utils.each(definition.ifaces,function(iface){add(definition,iface)}):add(definition,definition.iface||"object")},render:function($content,options){if(options.name||(options.name="default"),options.data)return render_best_view($content,options.data,options);if(options.every)return render_all_views($content,options.every,options);if(options.url)return render_url($content,options.url,options);throw{message:"Missing required options"}}};return registry}});var default_registry=module.Registry();$.extend(module,{view:function(definition){default_registry.register(definition)},render:function($content,options){return default_registry.render($content,options)}}),$.fn.render=function(options){return default_registry.render($(this),options)},infrae.views=module})(jQuery,infrae,jsontemplate);