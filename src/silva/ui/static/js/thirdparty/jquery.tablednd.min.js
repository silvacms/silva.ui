(function(jQuery){var module={currentTable:null,dragObject:null,mouseOffset:null,oldY:0,build:function(options){return this.each(function(){var tbody=this,config=jQuery.extend({onDragStyle:null,onDropStyle:null,onDragClass:"tDnD_whileDrag",onDrop:null,onDragStart:null,scrollAmount:5,dragHandle:null},options||{});jQuery(tbody).delegate("td."+config.dragHandle,"mousedown",function(event){var cell=event.target,drag=!0;return config.onDragStart&&(drag=config.onDragStart(cell)),drag!==!1?(module.dragObject=cell.parentNode,module.currentTable=tbody,module.mouseOffset=module.getMouseOffset(cell,event),event.stopPropagation(),event.preventDefault(),!1):void 0}),tbody.tableDnDConfig=config}),jQuery(document).bind("mousemove",module.mousemove).bind("mouseup",module.mouseup),this},mousePosition:function(ev){return ev.pageY?ev.pageY:ev.clientY+document.body.scrollTop-document.body.clientTop},getMouseOffset:function(target,ev){return ev=ev||window.event,this.mousePosition(ev)-this.documentPosition(target)},documentPosition:function(e){var top=0;for(0==e.offsetHeight&&(e=e.firstChild);e.offsetParent;)top+=e.offsetTop,e=e.offsetParent;return top+=e.offsetTop},mousemove:function(ev){if(null!=module.dragObject){var dragObj=jQuery(module.dragObject),config=module.currentTable.tableDnDConfig,mousePos=module.mousePosition(ev),y=mousePos-module.mouseOffset,yOffset=window.pageYOffset;if(document.all&&(document.compatMode!==void 0&&"BackCompat"!=document.compatMode?yOffset=document.documentElement.scrollTop:document.body!==void 0&&(yOffset=document.body.scrollTop)),config.scrollAmount>mousePos-yOffset)window.scrollBy(0,-config.scrollAmount);else{var windowHeight=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:document.body.clientHeight;config.scrollAmount>windowHeight-(mousePos-yOffset)&&window.scrollBy(0,config.scrollAmount)}if(y!=module.oldY){var movingDown=y>module.oldY;module.oldY=y,config.onDragClass?dragObj.addClass(config.onDragClass):dragObj.css(config.onDragStyle);var currentRow=module.findDropTargetRow(dragObj,y);currentRow&&(movingDown&&module.dragObject!=currentRow?module.dragObject.parentNode.insertBefore(module.dragObject,currentRow.nextSibling):movingDown||module.dragObject==currentRow||module.dragObject.parentNode.insertBefore(module.dragObject,currentRow))}return!1}},findDropTargetRow:function(draggedRow,y){for(var rows=$(module.currentTable).children("tr"),i=0,len=rows.length;len>i;i++){var row=rows[i],rowY=this.documentPosition(row),rowHeight=parseInt(row.offsetHeight)/2;if(0==row.offsetHeight&&(rowY=this.documentPosition(row.firstChild),rowHeight=parseInt(row.firstChild.offsetHeight)/2),y>rowY-rowHeight&&rowY+rowHeight>y){if(row==draggedRow)return null;var config=module.currentTable.tableDnDConfig;return config.onAllowDrop?config.onAllowDrop(draggedRow,row)?row:null:row}}return null},mouseup:function(event){if(module.currentTable&&module.dragObject){var droppedRow=module.dragObject,config=module.currentTable.tableDnDConfig;return config.onDragClass?jQuery(droppedRow).removeClass(config.onDragClass):jQuery(droppedRow).css(config.onDropStyle),module.dragObject=null,config.onDrop&&config.onDrop(droppedRow),module.currentTable=null,event.stopPropagation(),event.preventDefault(),!1}}};jQuery.fn.extend({tableDnD:module.build})})(jQuery);