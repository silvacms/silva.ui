(function(e){var t={currentTable:null,dragObject:null,mouseOffset:null,oldY:0,build:function(n){return this.each(function(){var r=this,i=e.extend({onDragStyle:null,onDropStyle:null,onDragClass:"tDnD_whileDrag",onDrop:null,onDragStart:null,scrollAmount:5,dragHandle:null},n||{});e(r).delegate("td."+i.dragHandle,"mousedown",function(e){var n=e.target,s=!0;i.onDragStart&&(s=i.onDragStart(n));if(s!==!1)return t.dragObject=n.parentNode,t.currentTable=r,t.mouseOffset=t.getMouseOffset(n,e),e.stopPropagation(),e.preventDefault(),!1}),r.tableDnDConfig=i}),e(document).bind("mousemove",t.mousemove).bind("mouseup",t.mouseup),this},mousePosition:function(e){return e.pageY?e.pageY:e.clientY+document.body.scrollTop-document.body.clientTop},getMouseOffset:function(e,t){return t=t||window.event,this.mousePosition(t)-this.documentPosition(e)},documentPosition:function(e){var t=0;e.offsetHeight==0&&(e=e.firstChild);while(e.offsetParent)t+=e.offsetTop,e=e.offsetParent;return t+=e.offsetTop,t},mousemove:function(n){if(t.dragObject==null)return;var r=e(t.dragObject),i=t.currentTable.tableDnDConfig,s=t.mousePosition(n),o=s-t.mouseOffset,u=window.pageYOffset;document.all&&(typeof document.compatMode!="undefined"&&document.compatMode!="BackCompat"?u=document.documentElement.scrollTop:typeof document.body!="undefined"&&(u=document.body.scrollTop));if(s-u<i.scrollAmount)window.scrollBy(0,-i.scrollAmount);else{var a=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:document.body.clientHeight;a-(s-u)<i.scrollAmount&&window.scrollBy(0,i.scrollAmount)}if(o!=t.oldY){var f=o>t.oldY;t.oldY=o,i.onDragClass?r.addClass(i.onDragClass):r.css(i.onDragStyle);var l=t.findDropTargetRow(r,o);l&&(f&&t.dragObject!=l?t.dragObject.parentNode.insertBefore(t.dragObject,l.nextSibling):!f&&t.dragObject!=l&&t.dragObject.parentNode.insertBefore(t.dragObject,l))}return!1},findDropTargetRow:function(e,n){var r=$(t.currentTable).children("tr");for(var i=0,s=r.length;i<s;i++){var o=r[i],u=this.documentPosition(o),a=parseInt(o.offsetHeight)/2;o.offsetHeight==0&&(u=this.documentPosition(o.firstChild),a=parseInt(o.firstChild.offsetHeight)/2);if(n>u-a&&n<u+a){if(o==e)return null;var f=t.currentTable.tableDnDConfig;return f.onAllowDrop?f.onAllowDrop(e,o)?o:null:o}}return null},mouseup:function(n){if(t.currentTable&&t.dragObject){var r=t.dragObject,i=t.currentTable.tableDnDConfig;return i.onDragClass?e(r).removeClass(i.onDragClass):e(r).css(i.onDropStyle),t.dragObject=null,i.onDrop&&i.onDrop(r),t.currentTable=null,n.stopPropagation(),n.preventDefault(),!1}}};e.fn.extend({tableDnD:t.build})})(jQuery);