(function($,infrae,jsontemplate){var NavigationManager=function(smi,options){var $navigation=$(options.navigation.selector),$tree=$navigation.children(".tree"),screen="content",root_url=options.navigation.root_url,url=new jsontemplate.Template(options.navigation.url,{});new jsontemplate.Template(options.navigation.parents_url,{});var scroll=function(node,depth){return node.each(function(){0>depth&&(depth=0),$tree.scrollLeft(21*depth)})},open=function(parents){function open_node_chain(remaining){var parent_node=$("#"+remaining[0]),left=remaining.slice(1);return parent_node.length>0?(left.length>0?$tree.jstree("open_node",parent_node,function(){open_node_chain(left)}):$tree.jstree("open_node",parent_node,function(){$tree.jstree("select_node",parent_node,!0)}),!0):!1}open_node_chain(parents)||$tree.jstree("deselect_all")},remove=function(info){if(void 0!==info.target){var $node=$("#"+info.target,$tree);$node.length>0&&$tree.jstree("delete_node",$node)}},add=function(info){if(void 0!==info.parent){var $parent=$("#"+info.parent,$tree);$parent.length>0&&$tree.jstree("refresh",$parent)}},invalidate=function(data){data.length>0&&infrae.utils.each(data,function(datum){switch(datum.action){case"remove":remove(datum.info);break;case"add":case"update":add(datum.info)}})};return $tree.jstree({ui:{select_limit:1},core:{animation:100},plugins:["json_data","ui","hotkeys"],json_data:{ajax:{url:function(node){return-1==node?root_url:url.expand({path:node.data("jstree").path})}}}}),$tree.bind("select_node.jstree",function(event,data){scroll($(this),data.rslt.obj.parents("ul").length-2)}),$tree.bind("open_node.jstree",function(event,data){scroll($(this),data.rslt.obj.parents("ul").length-2)}),$tree.bind("close_node.jstree",function(event,data){scroll($(this),data.rslt.obj.parents("ul").length-3)}),$tree.delegate("a","click",function(){return smi.open_screen($(this).parent().data("jstree").path,screen),!1}),infrae.ui.selection.disable($navigation),$tree.jstree("disable_hotkeys"),$navigation.bind("blur-keyboard",function(){$tree.jstree("disable_hotkeys")}),$navigation.bind("focus-keyboard",function(){$tree.jstree("enable_hotkeys"),$tree.focus()}),smi.shortcuts.create("navigation",$tree),{page:function(data){return void 0!=data.navigation&&(void 0!=data.navigation.invalidation&&invalidate(data.navigation.invalidation),void 0!=data.navigation.current&&open(data.navigation.current),screen=data.navigation.screen?data.navigation.screen:smi.opening.screen),null}}};$.extend(infrae.smi.plugins,{navigation:NavigationManager})})(jQuery,infrae,jsontemplate);