(function($,infrae,jsontemplate){var Node=function(nodes,$node,data){var api={expand:function(){var promise=$.Deferred().resolve(data);return"closed"==data.state&&($node.removeClass("nav-closed"),$node.addClass("nav-open"),data.children&&(data.loaded||(promise=nodes.fetch(data.path,[data.id])),promise=promise.then(function(){var $child=nodes.render(data.children);return $child.hide(),$node.append($child),$child.slideDown(150),data})),data.state="open"),promise},collapse:function(){if("open"==data.state){$node.removeClass("nav-open"),$node.addClass("nav-closed"),$node.children("ul").remove(),data.state="closed";var close=function(data){for(var i=0,len=data.children.length;len>i;i++){var child=nodes.get_data(data.children[i]);null!==child&&"open"==child.state&&(child.state="closed",close(child))}};close(data)}},toggle:function(){"open"==data.state?api.collapse():"closed"==data.state&&api.expand()}};return api},Nodes=function($root,url){var render=new jsontemplate.Template('<li id="nav-{id}" class="nav-{state|htmltag}" data-path="{path|htmltag}"><ins class="icon nav-status" /><a>{.section icon}<ins class="icon {@|htmltag}" />{.end}{.section url}<ins class="icon" style="background:url(\'{@|htmltag}\') no-repeat center center;" />{.end}{title}</a></li>'),nodes={},dom_node_id_to_id=/nav-(\d+)/,api={get_data:function(id){return nodes[id]},get_dom:function(id){return $root.find("#nav-"+id)},get_node:function($node){var match=$node.attr("id").match(dom_node_id_to_id);if(match){var id=+match[1];if(void 0!==nodes[id])return Node(api,$node,nodes[id])}return null},add:function(id,container_id,position){var container=api.get_data(container_id);if(void 0!==container){var $container=api.get_dom(container_id);void 0===container.children&&(container.children=[]),0>position?container.children.push(id):container.children.splice(position,0,id),"open"==container.state?api.fetch(container.path,[container.id,id]).then(function(){var $node=api.render([id]).children("li"),$list=$container.children("ul");position>0?$list.children("li:nth("+(position-1)+")").after($node):position?$list.append($node):$list.prepand($node)}):"item"==container.state&&(container.state="closed",$container.length&&($container.removeClass("nav-item"),$container.addClass("nav-closed")))}},update:function(id,container_id,position){var container=api.get_data(container_id),node=api.get_data(id);if(void 0!==container&&void 0!==container.children){var index=$.inArray(id,container.children);if(index!=position){var $container=api.get_dom(container_id),$node=api.get_dom(id);if(container.children.splice(index,1),container.children.splice(position,0,id),$container.length&&$node.length){var $list=$container.children("ul");$node.detach(),position?$list.children("li:nth("+(position-1)+")").after($node):$list.prepend($node)}}}void 0!==node&&api.fetch(node.path,[]).then(function(){var updated=api.get_data(id),$node=api.get_dom(id);if(updated.state=node.state,updated.loaded=node.loaded,$node.length){var $updated=$(render.expand(updated)).children("a");$node.children("a").replaceWith($updated)}})},remove:function(id,container_id){var container=api.get_data(container_id);if(void 0!==nodes[id]){var $node=api.get_dom(id),remove=function(id){var node=nodes[id];if(void 0!==node){if(node.children)for(var i=0,len=node.children.length;len>i;i++)remove(node.children[i]);delete nodes[id]}};$node.remove(),remove(id)}if(void 0!==container&&void 0!==container.children){var index=$.inArray(id,container.children);if(index>-1&&(container.children.splice(index,1),!container.children.length)){var $container=api.get_dom(container_id);"open"==container.state?($container.removeClass("nav-open"),$container.addClass("nav-item"),$container.children("ul").remove()):$container.removeClass("nav-closed"),$container.addClass("nav-item"),container.state="item"}}},fetch:function(path,ids){for(var data=[],i=0,len=ids.length;len>i;i++)data.push({name:"recurse",value:ids[i]});return $.ajax({url:url.expand({path:path}),type:"POST",data:data,dataType:"json"}).then(function(additions){for(var added=[],i=0,len=additions.length;len>i;i++)nodes[additions[i].id]=additions[i],added.push(additions[i].id);return added})},render:function(ids){for(var $nodes=$("<ul />"),i=0,len=ids.length;len>i;i++){var node=nodes[ids[i]],$node=$(render.expand(node));node.children&&"open"==node.state&&$node.append(api.render(node.children)),$nodes.append($node)}return $nodes},expand:function(ids){for(var node={id:ids[0],path:"",state:"item",loaded:!0,children:[ids[0]]},next=void 0,open=null,deferred=null,index=0,len=ids.length;len>index;index++){if(next=nodes[ids[index]],void 0===next){for(var requires=[node.id];len>index;index++)requires.push(ids[index]);null===open&&(open=node),deferred=api.fetch(node.path,requires);break}node=next,null===open&&"closed"==node.state&&(open=node)}return null!==deferred||node.loaded||(null===open&&(open=node),deferred=api.fetch(node.path,[node.id])),null!==open?(null===deferred&&(deferred=$.Deferred().resolve([])),deferred.then(function(){var $node=api.get_dom(open.id),$child=api.render(open.children);return open.state="open",$child.hide(),$node.length?($node.removeClass("nav-closed"),$node.addClass("nav-open"),$node.append($child)):($child.children("li").addClass("nav-root"),$root.append($child)),$child.slideDown(150),open})):$.Deferred().resolve()}};return api},NavigationManager=function(smi,options){var $root=$(options.navigation.selector).children(".tree"),url=jsontemplate.Template(options.navigation.url,{}),$current=null,nodes=Nodes($root,url);return $root.delegate("a","click",function(){var $node=$(this).parent();smi.open_screen($node.data("path"))}),$root.delegate("ins.nav-status","click",function(){nodes.get_node($(this).parent()).toggle()}),{page:function(data){if(void 0!==data.navigation){if(void 0!==data.navigation.invalidation){var records=data.navigation.invalidation;records.length>0&&infrae.utils.each(records,function(record){switch(record.action){case"add":nodes.add(record.id,record.container,+record.position);break;case"update":nodes.update(record.id,record.container,+record.position);break;case"remove":nodes.remove(record.id,record.container)}})}if(void 0!==data.navigation.current){var current=data.navigation.current;null!==$current&&$current.removeClass("nav-current"),nodes.expand(current).then(function(){var $node=nodes.get_dom(current[current.length-1]);$node.addClass("nav-current"),$current=$node})}}return null}}};$.extend(infrae.smi.plugins,{navigation:NavigationManager})})(jQuery,infrae,jsontemplate);